<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>deepAlpha Copilot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #chat-container::-webkit-scrollbar { width: 4px; }
        #chat-container::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 20px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-900">
    <div class="max-w-6xl mx-auto py-6 px-4 space-y-6">
        <header class="bg-slate-900 text-slate-100 rounded-2xl p-6 shadow-lg">
            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-400 mb-2">deepAlpha Copilot</p>
                    <h1 class="text-3xl md:text-4xl font-semibold">Deep Alpha</h1>
                    <p class="mt-3 text-sm text-slate-300">
                        We translate fundamentals, financials, sentiment, leadership, events, and technical signals into a concise outlook so you can act with conviction.
                    </p>
                </div>
                <form id="score-form" class="bg-slate-800/60 rounded-xl p-4 flex flex-col md:flex-row md:items-center gap-3 w-full md:w-96">
                    <div class="flex-1">
                        <label for="score-ticker" class="text-xs uppercase tracking-wide text-slate-400">Ticker symbol</label>
                        <input type="text" id="score-ticker" value="NVDA" class="mt-1 w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 text-slate-100 focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 uppercase" placeholder="NVDA" />
                    </div>
                    <button type="submit" class="inline-flex items-center justify-center bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-semibold px-4 py-2 rounded-lg transition">Generate</button>
                </form>
            </div>
        </header>

        <section id="scoreboard" class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6">
            <p class="text-sm text-slate-500">Loading scorecard...</p>
        </section>

        <section id="score-table" class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-800">Coverage Universe</h2>
                <button id="load-all-btn" class="inline-flex items-center bg-slate-900 hover:bg-slate-800 text-white text-sm font-medium px-4 py-2 rounded-lg transition">Refresh snapshot</button>
            </div>
            <p class="mt-2 text-sm text-slate-500">Click refresh to load the latest scores for every ticker we track.</p>
            <div class="mt-4 text-sm text-slate-400">Press refresh to populate the snapshot.</div>
        </section>

        <section class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6">
            <button id="toggleMethodology" class="flex items-center justify-between w-full text-left focus:outline-none">
                <h2 class="text-lg font-semibold text-slate-800">Score Calculation Methodology</h2>
                <svg id="methodologyChevron" class="w-5 h-5 text-slate-500 transform rotate-0 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="methodologyContent" class="mt-4 hidden text-sm text-slate-600 space-y-4">
                <p class="text-slate-700">This section provides a detailed explanation of how each score component is calculated, including data sources, time periods, and thresholds.</p>

                <div class="grid gap-4 md:grid-cols-2">
                    <div class="space-y-3">
                        <h4 class="font-semibold text-slate-700">BUSINESS Score:</h4>
                        <p><strong>Data Sources:</strong> Yahoo Finance financials, SEC filings</p>
                        <p><strong>Time Period:</strong> Last 4 quarters for CAGR, latest quarter for margins</p>
                        <p><strong>Calculation:</strong> Revenue CAGR (Compound Annual Growth Rate), Gross Margin, R&D Intensity, Industry Score. Component scores are averaged and clamped between 0-10.</p>
                        <p><strong>Thresholds:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-xs space-y-1">
                            <li>Revenue CAGR: [(-5%, 2pts), (0%, 4pts), (5%, 6pts), (15%, 8pts), (30%, 10pts)]</li>
                            <li>Gross Margin: [(20%, 3pts), (35%, 5pts), (45%, 7pts), (55%, 9pts), (65%, 10pts)]</li>
                            <li>R&D Intensity: [(5%, 4pts), (10%, 6pts), (15%, 8pts), (20%, 9pts), (30%, 10pts)]</li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                        <h4 class="font-semibold text-slate-700">FINANCIAL Score:</h4>
                        <p><strong>Data Sources:</strong> Yahoo Finance fundamentals, company financials</p>
                        <p><strong>Time Period:</strong> Last 4 quarters for trends, latest values for ratios</p>
                        <p><strong>Calculation:</strong> Revenue CAGR, Net Margin, FCF/Debt coverage, D/E ratio, P/E ratio, P/S ratio. Component scores averaged and clamped.</p>
                        <p><strong>Thresholds:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-xs space-y-1">
                            <li>Revenue CAGR: Same as Business score</li>
                            <li>Net Margin: [(0%, 3pts), (5%, 5pts), (10%, 6.5pts), (20%, 8.5pts), (30%, 10pts)]</li>
                            <li>FCF/Debt: [(0.2x, 3pts), (0.5x, 5pts), (1x, 7pts), (1.5x, 9pts), (2x, 10pts)]</li>
                            <li>D/E Ratio: [(50%, 9.5pts), (100%, 8.5pts), (200%, 6.5pts), (300%, 4.5pts), (500%, 3pts)]</li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                        <h4 class="font-semibold text-slate-700">SENTIMENT Score:</h4>
                        <p><strong>Data Sources:</strong> Yahoo Finance news, Reddit API</p>
                        <p><strong>Time Period:</strong> Last 30 days (weighted by recency)</p>
                        <p><strong>Calculation:</strong> VADER sentiment analysis on news headlines + Reddit bullish ratio. Scores weighted by coverage and averaged.</p>
                        <p><strong>Thresholds:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-xs space-y-1">
                            <li>News Sentiment: [(-0.6, 1pt), (-0.2, 4pts), (0, 5.5pts), (0.2, 7.5pts), (0.45, 9.5pts)]</li>
                            <li>Reddit Ratio: [(-0.6, 2pts), (-0.2, 4pts), (0, 6pts), (0.2, 8pts), (0.4, 9.5pts)]</li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                        <h4 class="font-semibold text-slate-700">TECHNICAL Score:</h4>
                        <p><strong>Data Sources:</strong> Yahoo Finance price data</p>
                        <p><strong>Time Period:</strong> Latest trading data</p>
                        <p><strong>Calculation:</strong> RSI (14-day), MACD (12,26,9), Moving Averages (50,200). Base score 5.0 with adjustments.</p>
                        <p><strong>Rules:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-xs space-y-1">
                            <li>RSI < 30: +3pts (oversold), RSI > 70: -3pts (overbought)</li>
                            <li>MACD bullish crossover: +2pts, bearish: -2pts</li>
                            <li>MA50 > MA200: +3pts (golden cross), else -2pts</li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                        <h4 class="font-semibold text-slate-700">CRITICAL Score:</h4>
                        <p><strong>Data Sources:</strong> Internal assessment framework</p>
                        <p><strong>Time Period:</strong> Static mapping based on strategic importance</p>
                        <p><strong>Calculation:</strong> Pre-defined criticality scores (5-10pts) based on industry and strategic positioning.</p>
                        <p><strong>Examples:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-xs space-y-1">
                            <li>NVDA: 10.0pts (AI/semiconductor leader)</li>
                            <li>TSM: 9.0pts (chip manufacturing critical)</li>
                            <li>SMR: 7.0pts (nuclear energy infrastructure)</li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                        <h4 class="font-semibold text-slate-700">LEADERSHIP Score:</h4>
                        <p><strong>Data Sources:</strong> Yahoo Finance officers, CEO profile reports</p>
                        <p><strong>Time Period:</strong> Current leadership data</p>
                        <p><strong>Calculation:</strong> CEO tenure, compensation, officer count, reputation bonus.</p>
                        <p><strong>Thresholds:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-xs space-y-1">
                            <li>CEO Tenure: [(2yrs, 6pts), (4yrs, 7pts), (6yrs, 8pts), (10yrs, 9pts), (15yrs, 9.5pts)]</li>
                            <li>Compensation: (>$5M: 8.5pts, >$10M: 9.5pts)</li>
                            <li>Officer Count: (5+ officers: 7.5pts)</li>
                            <li>Co-founder bonus: 9.0pts</li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                        <h4 class="font-semibold text-slate-700">EARNINGS Score:</h4>
                        <p><strong>Data Sources:</strong> Quarterly earnings data, Yahoo Finance</p>
                        <p><strong>Time Period:</strong> Quarterly earnings history</p>
                        <p><strong>Calculation:</strong> EPS trend, Revenue trend, Consistency metrics. Component scores averaged.</p>
                        <p><strong>Thresholds:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-xs space-y-1">
                            <li>EPS Trend: [(-10%, 2pts), (0%, 4pts), (5%, 6pts), (15%, 8.5pts), (30%, 10pts)]</li>
                            <li>Revenue Trend: [(-5%, 2pts), (0%, 4pts), (5%, 6.5pts), (15%, 8.5pts), (30%, 10pts)]</li>
                            <li>Consistency: [(2, 4pts), (5, 6pts), (10, 8pts), (15, 9pts), (25, 10pts)]</li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                        <h4 class="font-semibold text-slate-700">Overall Score:</h4>
                        <p><strong>Weighting:</strong> Business (20%), Financial (25%), Sentiment (15%), Critical (10%), Leadership (10%), Earnings (10%), Technical (10%)</p>
                        <p><strong>Recommendation:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-xs space-y-1">
                            <li>8.0+ → Strong Buy (Long-term 12-24 months)</li>
                            <li>7.0+ → Buy (Long-term 12-18 months)</li>
                            <li>4.0+ → Hold (Medium-term 6-12 months)</li>
                            <li>&lt;4.0 → Sell (Short-term &lt;6 months)</li>
                        </ul>
                        <p><strong>Confidence:</strong> Based on score variance - higher variance = lower confidence</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl shadow-lg border border-slate-200">
                <div id="chat-container" class="p-6 overflow-y-auto h-96 space-y-4">
                    <div class="flex justify-start">
                        <div class="bg-slate-100 text-slate-800 p-4 rounded-xl max-w-md shadow">
                            <p>
                                Hello! Ask anything about a company and we will synthesize fundamentals, filings, sentiment,
                                leadership intel, critical-path exposure, and chart signals. Try “Decode NVDA’s moat and near-term catalysts.”
                            </p>
                        </div>
                    </div>
                </div>
                <div class="border-t border-slate-200 p-4">
                    <form id="chat-form" class="flex items-center gap-3">
                        <input type="text" id="user-input" placeholder="Ask a financial question..." class="flex-1 px-4 py-3 border border-slate-300 rounded-full focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400" />
                        <button type="submit" class="bg-slate-900 text-white p-3 rounded-full hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </form>
                </div>
            </div>

            <aside id="insight-panel" class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6">
                <h2 class="text-lg font-semibold text-slate-800 mb-3">Insights & Signals</h2>
                <p class="text-sm text-slate-500 mb-4">Get contextual explanations for each score, major risks, catalysts, and why a company matters on the critical path.</p>
                <div id="insight-content" class="space-y-4 text-sm text-slate-600">
                    <p>Select a ticker to populate this panel.</p>
                </div>
            </aside>
        </section>
    </div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatContainer = document.getElementById('chat-container');
        const scoreForm = document.getElementById('score-form');
        const scoreTickerInput = document.getElementById('score-ticker');
        const scoreboard = document.getElementById('scoreboard');
        const scoreTable = document.getElementById('score-table');
        const loadAllBtn = document.getElementById('load-all-btn');
        const insightContent = document.getElementById('insight-content');

        const apiUrl = window.location.origin + '/chat';
        const scoreApiUrl = ticker => `${window.location.origin}/api/scores/${encodeURIComponent(ticker)}`;
        const supportedTickers = ["NVDA","MU","AVGO","TSM","VRT","SMCI","INOD","RR","IREN","CIFR","RIOT","OKLO","SMR","CCJ","VST","NXE","EOSE","QS"];
        
        // Company metadata for enhanced display
        const companyMetadata = {
            "NVDA": { name: "NVIDIA Corp", industry: "Semiconductors" },
            "MU": { name: "Micron Technology Inc", industry: "Semiconductors" },
            "AVGO": { name: "Broadcom Inc", industry: "Semiconductors" },
            "TSM": { name: "Taiwan Semiconductor Manufacturing Co Ltd", industry: "Semiconductors" },
            "VRT": { name: "Vertiv Holdings Co", industry: "Industrial Equipment" },
            "SMCI": { name: "Super Micro Computer Inc", industry: "Computer Hardware" },
            "INOD": { name: "Innodata Inc", industry: "Information Technology Services" },
            "RR": { name: "Richtech Robotics Inc", industry: "Industrial Machinery" },
            "IREN": { name: "Iren Ltd", industry: "Utilities" },
            "CIFR": { name: "Cipher Mining Inc", industry: "Cryptocurrency Mining" },
            "RIOT": { name: "Riot Platforms Inc", industry: "Cryptocurrency Mining" },
            "OKLO": { name: "Oklo Inc", industry: "Nuclear Energy" },
            "SMR": { name: "NuScale Power Corp", industry: "Nuclear Energy" },
            "CCJ": { name: "Cameco Corp", industry: "Uranium Mining" },
            "VST": { name: "Vistra Corp", industry: "Utilities" },
            "NXE": { name: "NexGen Energy Ltd", industry: "Uranium Mining" },
            "EOSE": { name: "Eos Energy Enterprises Inc", industry: "Energy Storage" },
            "QS": { name: "QuantumScape Corp", industry: "Battery Technology" }
        };

        async function fetchWithNewsContext(question) {
            try {
                const response = await fetch(`${window.location.origin}/api/scores/${encodeURIComponent(scoreTickerInput.value.trim().toUpperCase())}?news_only=true&query=${encodeURIComponent(question)}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success' && result.data && result.data.latest_news) {
                        return result.data.latest_news;
                    }
                }
            } catch (error) {
                console.warn('Unable to fetch news context', error);
            }
            return [];
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = userInput.value.trim();
            if (!question) return;

            addMessage(question, 'user');
            userInput.value = '';

            const typingIndicator = addMessage('...', 'bot', true);

            let augmentedQuestion = question;
            const newsContext = await fetchWithNewsContext(question);
            if (newsContext.length) {
                const contextText = newsContext.map(item => `• ${item.title} (${item.source})`).join('\n');
                augmentedQuestion = `${question}\n\nLatest headlines:\n${contextText}`;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: augmentedQuestion })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                typingIndicator.remove();
                addMessage(data.answer, 'bot');
            } catch (error) {
                console.error('Error fetching from API:', error);
                typingIndicator.remove();
                addMessage('Sorry, I am having trouble connecting right now. Please retry in a moment.', 'bot');
            }
        });

        function addMessage(text, sender, isTyping = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `px-4 py-3 rounded-xl max-w-md shadow ${sender === 'user' ? 'bg-slate-900 text-white' : 'bg-white text-slate-800 border border-slate-200'}`;
            messageBubble.innerHTML = text.replace(/\n/g, '<br>');

            if (isTyping) {
                messageBubble.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
                messageWrapper.id = "typing-indicator";
            }

            messageWrapper.appendChild(messageBubble);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageWrapper;
        }

        function scoreColor(score) {
            if (score === null || score === undefined) return 'bg-slate-200 text-slate-700';
            if (score >= 7.5) return 'bg-green-100 text-green-800';
            if (score >= 5.0) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }

        function getScoreMethodology(scoreType, component) {
            const methodologies = {
                business: `
                    <div><strong>Data Sources:</strong> Yahoo Finance financials, SEC filings</div>
                    <div><strong>Time Period:</strong> Last 4 quarters for CAGR, latest quarter for margins</div>
                    <div><strong>Calculation:</strong> Revenue CAGR (30%+ = 10pts), Gross Margin (65%+ = 10pts), R&D Intensity (20%+ = 10pts), Industry Score (6-10pts)</div>
                    <div><strong>Inputs:</strong> ${Object.entries(component.inputs || {}).filter(([k,v]) => v !== null && v !== undefined).map(([k,v]) => `${k}: ${typeof v === 'number' ? v.toFixed(2) : v}`).join(', ')}</div>
                `,
                financial: `
                    <div><strong>Data Sources:</strong> Yahoo Finance fundamentals, company financials</div>
                    <div><strong>Time Period:</strong> Last 4 quarters for trends, latest values for ratios</div>
                    <div><strong>Calculation:</strong> Revenue CAGR (30%+ = 10pts), Net Margin (20%+ = 8.5pts), FCF/Debt (2x+ = 10pts), D/E (50- = 9.5pts), P/E (15- = 9.5pts), P/S (2- = 9pts)</div>
                    <div><strong>Inputs:</strong> ${Object.entries(component.inputs || {}).filter(([k,v]) => v !== null && v !== undefined).map(([k,v]) => `${k}: ${typeof v === 'number' ? v.toFixed(2) : v}`).join(', ')}</div>
                `,
                sentiment: `
                    <div><strong>Data Sources:</strong> Yahoo Finance news, Reddit API</div>
                    <div><strong>Time Period:</strong> Last 30 days (weighted by recency)</div>
                    <div><strong>Calculation:</strong> News sentiment via VADER analysis (0.45+ = 9.5pts), Reddit bullish ratio (0.4+ = 9.5pts)</div>
                    <div><strong>Inputs:</strong> ${Object.entries(component.inputs || {}).filter(([k,v]) => v !== null && v !== undefined).map(([k,v]) => `${k}: ${typeof v === 'number' ? v.toFixed(2) : v}`).join(', ')}</div>
                `,
                critical: `
                    <div><strong>Data Sources:</strong> Internal assessment framework</div>
                    <div><strong>Time Period:</strong> Static mapping based on strategic importance</div>
                    <div><strong>Calculation:</strong> Pre-defined criticality scores (5-10pts) based on industry and strategic positioning</div>
                    <div><strong>Inputs:</strong> ${Object.entries(component.inputs || {}).filter(([k,v]) => v !== null && v !== undefined).map(([k,v]) => `${k}: ${typeof v === 'number' ? v.toFixed(2) : v}`).join(', ')}</div>
                `,
                leadership: `
                    <div><strong>Data Sources:</strong> Yahoo Finance officers, CEO profile reports</div>
                    <div><strong>Time Period:</strong> Current leadership data</div>
                    <div><strong>Calculation:</strong> CEO tenure (15+ yrs = 9.5pts), compensation (>$10M = 9.5pts), officer count (5+ = 7.5pts), reputation bonus</div>
                    <div><strong>Inputs:</strong> ${Object.entries(component.inputs || {}).filter(([k,v]) => v !== null && v !== undefined).map(([k,v]) => `${k}: ${typeof v === 'number' ? v.toFixed(2) : v}`).join(', ')}</div>
                `,
                earnings: `
                    <div><strong>Data Sources:</strong> Quarterly earnings data, Yahoo Finance</div>
                    <div><strong>Time Period:</strong> Quarterly earnings history</div>
                    <div><strong>Calculation:</strong> EPS trend (30%+ = 10pts), Revenue trend (30%+ = 10pts), Consistency score (25+ = 10pts)</div>
                    <div><strong>Inputs:</strong> ${Object.entries(component.inputs || {}).filter(([k,v]) => v !== null && v !== undefined).map(([k,v]) => `${k}: ${typeof v === 'number' ? v.toFixed(2) : v}`).join(', ')}</div>
                `,
                technical: `
                    <div><strong>Data Sources:</strong> Yahoo Finance price data</div>
                    <div><strong>Time Period:</strong> Latest trading data</div>
                    <div><strong>Calculation:</strong> RSI (30-70 = neutral), MACD crossover (±2pts), Moving average alignment (±3pts), Base score 5.0</div>
                    <div><strong>Inputs:</strong> ${Object.entries(component.inputs || {}).filter(([k,v]) => v !== null && v !== undefined).map(([k,v]) => `${k}: ${typeof v === 'number' ? v.toFixed(2) : v}`).join(', ')}</div>
                `
            };
            return methodologies[scoreType] || '<div>Methodology not available</div>';
        }

        function generateEventSummary(timeline) {
            if (!timeline || timeline.length === 0) {
                return '<div class="text-sm text-slate-500">No recent events to summarize.</div>';
            }
            
            const recentEvents = timeline.filter(event => {
                const eventDate = new Date(event.published_at);
                const fiveDaysAgo = new Date();
                fiveDaysAgo.setDate(fiveDaysAgo.getDate() - 5);
                return eventDate >= fiveDaysAgo;
            });
            
            if (recentEvents.length === 0) {
                return '<div class="text-sm text-slate-500">No events in the past 5 days.</div>';
            }
            
            const positiveEvents = recentEvents.filter(e => e.sentiment > 0.1).length;
            const negativeEvents = recentEvents.filter(e => e.sentiment < -0.1).length;
            const neutralEvents = recentEvents.length - positiveEvents - negativeEvents;
            
            let sentimentSummary = '';
            if (positiveEvents > negativeEvents) {
                sentimentSummary = 'Recent sentiment is <strong>positive</strong>, supporting a bullish outlook.';
            } else if (negativeEvents > positiveEvents) {
                sentimentSummary = 'Recent sentiment is <strong>negative</strong>, suggesting caution.';
            } else {
                sentimentSummary = 'Recent sentiment is <strong>mixed</strong>, requiring careful analysis.';
            }
            
            return `
                <div class="space-y-2">
                    <div class="text-sm font-medium text-slate-700">Past 5 Days Summary (${recentEvents.length} events)</div>
                    <div class="text-sm text-slate-600">${sentimentSummary}</div>
                    <div class="text-xs text-slate-500">
                        Positive: ${positiveEvents} | Negative: ${negativeEvents} | Neutral: ${neutralEvents}
                    </div>
                </div>
            `;
        }

        function generateEventImpactAnalysis(timeline, ticker) {
            if (!timeline || timeline.length === 0) {
                return '<div class="text-sm text-slate-500">No recent events to analyze.</div>';
            }
            
            // Organize events by time periods
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const threeDaysAgo = new Date(today);
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const todayEvents = timeline.filter(event => {
                const eventDate = new Date(event.published_at);
                return eventDate >= today;
            });
            
            const past3DaysEvents = timeline.filter(event => {
                const eventDate = new Date(event.published_at);
                return eventDate >= threeDaysAgo && eventDate < today;
            });
            
            const past7DaysEvents = timeline.filter(event => {
                const eventDate = new Date(event.published_at);
                return eventDate >= sevenDaysAgo && eventDate < threeDaysAgo;
            });
            
            // Function to calculate sentiment and generate summary
            function analyzePeriod(events, periodName, periodColor) {
                if (events.length === 0) {
                    return `
                        <div class="p-3 rounded-lg border border-slate-200 bg-slate-50">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-medium text-slate-700">${periodName}</h4>
                                <span class="text-xs text-slate-500">No events</span>
                            </div>
                            <p class="text-xs text-slate-500">No news events recorded for this period.</p>
                        </div>
                    `;
                }
                
                const positiveEvents = events.filter(e => e.sentiment > 0.1);
                const negativeEvents = events.filter(e => e.sentiment < -0.1);
                const neutralEvents = events.filter(e => e.sentiment >= -0.1 && e.sentiment <= 0.1);
                
                const avgSentiment = events.reduce((sum, e) => sum + e.sentiment, 0) / events.length;
                
                let sentimentLabel = '';
                let sentimentColor = '';
                let sentimentBg = '';
                
                if (avgSentiment > 0.1) {
                    sentimentLabel = 'Positive';
                    sentimentColor = 'text-green-700';
                    sentimentBg = 'bg-green-50 border-green-200';
                } else if (avgSentiment < -0.1) {
                    sentimentLabel = 'Negative';
                    sentimentColor = 'text-red-700';
                    sentimentBg = 'bg-red-50 border-red-200';
                } else {
                    sentimentLabel = 'Neutral';
                    sentimentColor = 'text-yellow-700';
                    sentimentBg = 'bg-yellow-50 border-yellow-200';
                }
                
                const sources = [...new Set(events.map(e => e.source).filter(Boolean))];
                const keyEvents = events.slice(0, 2).map(event => `
                    <li class="flex items-start space-x-2 text-xs">
                        <span class="mt-1 inline-block h-1 w-1 rounded-full ${event.sentiment >= 0.2 ? 'bg-green-500' : event.sentiment <= -0.2 ? 'bg-red-500' : 'bg-yellow-500'}"></span>
                        <div class="flex-1">
                            <div class="flex items-start justify-between">
                                <span class="text-slate-600 flex-1">${event.title.length > 50 ? event.title.substring(0, 50) + '...' : event.title}</span>
                                ${event.link ? `<a href="${event.link}" target="_blank" class="ml-2 text-blue-500 hover:text-blue-700" title="Read full article">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </a>` : ''}
                            </div>
                            <div class="flex items-center justify-between mt-1">
                                <div class="flex items-center space-x-2">
                                    <span class="text-slate-400 text-xs">${new Date(event.published_at).toLocaleDateString()}</span>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">
                                        ${event.source || 'Unknown'}
                                    </span>
                                </div>
                                <span class="text-xs ${event.sentiment > 0.1 ? 'text-green-600' : event.sentiment < -0.1 ? 'text-red-600' : 'text-yellow-600'}">
                                    ${event.sentiment > 0.1 ? '↗' : event.sentiment < -0.1 ? '↘' : '→'}
                                </span>
                            </div>
                        </div>
                    </li>
                `).join('');
                
                return `
                    <div class="p-3 rounded-lg border ${sentimentBg}">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-medium ${sentimentColor}">${periodName}</h4>
                            <div class="flex items-center space-x-2">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${sentimentColor} ${sentimentBg} border">
                                    ${sentimentLabel}
                                </span>
                                <span class="text-xs text-slate-500">${events.length} events</span>
                            </div>
                        </div>
                        
                        <div class="text-xs text-slate-600 mb-2">
                            <span class="font-medium">Sentiment Breakdown:</span> 
                            ${positiveEvents.length} positive, ${negativeEvents.length} negative, ${neutralEvents.length} neutral
                        </div>
                        
                        ${keyEvents ? `
                            <div class="mb-2">
                                <div class="text-xs font-medium text-slate-600 mb-1">Key Events:</div>
                                <ul class="space-y-1">
                                    ${keyEvents}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${sources.length > 0 ? `
                            <div class="mt-2 pt-2 border-t border-slate-200">
                                <div class="text-xs font-medium text-slate-600 mb-1">Sources:</div>
                                <div class="flex flex-wrap gap-1">
                                    ${sources.map(source => `
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-slate-100 text-slate-600 border">
                                            ${source}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            return `
                <div class="space-y-3">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Recent News Analysis</h3>
                        <span class="text-xs text-slate-500">Supporting ${ticker} recommendation</span>
                    </div>
                    
                    ${analyzePeriod(todayEvents, "Today's News", "blue")}
                    ${analyzePeriod(past3DaysEvents, "Past 3 Days", "green")}
                    ${analyzePeriod(past7DaysEvents, "Past 7 Days", "purple")}
                    
                    <div class="mt-4 p-3 rounded-lg bg-slate-50 border border-slate-200">
                        <div class="text-xs text-slate-600">
                            <strong>Analysis Summary:</strong> News sentiment analysis provides context for recent price movements and market sentiment. 
                            Positive sentiment may support bullish positions, while negative sentiment suggests caution. 
                            Consider this alongside technical analysis and fundamental factors for investment decisions.
                        </div>
                    </div>
                </div>
            `;
        }

        function renderScoreboard(data) {
            const company = data.company;
            const overall = data.overall;
            const scores = data.scores;
            const timeline = data.event_timeline || [];

            const componentCards = Object.entries(scores).map(([key, component]) => {
                const label = key.charAt(0).toUpperCase() + key.slice(1);
                const score = component.score !== null && component.score !== undefined ? component.score.toFixed(1) : '—';
                
                // Get methodology explanation for each score
                const methodology = getScoreMethodology(key, component);
                
                return `
                    <div class="rounded-xl border border-slate-200 bg-white/70 p-4 shadow-sm relative">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <h3 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">${label}</h3>
                                <div class="group relative">
                                    <svg class="w-4 h-4 text-slate-400 hover:text-slate-600 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block bg-slate-900 text-white text-xs rounded-lg p-3 w-80 z-10 shadow-lg">
                                        <div class="space-y-2">
                                            ${methodology}
                                        </div>
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-slate-900"></div>
                                    </div>
                                </div>
                            </div>
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold ${scoreColor(component.score)}">${score}</span>
                        </div>
                        <p class="mt-2 text-sm text-slate-600 leading-relaxed">${component.summary || 'No summary available.'}</p>
                    </div>
                `;
            }).join('');

            const timelineHtml = timeline.length
                ? timeline.map(item => `
                    <li class="flex items-start space-x-3">
                        <span class="mt-1 inline-block h-2 w-2 rounded-full ${item.sentiment >= 0.2 ? 'bg-green-500' : item.sentiment <= -0.2 ? 'bg-red-500' : 'bg-yellow-500'}"></span>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-slate-800">${item.title || 'Event'}</p>
                            <p class="text-xs text-slate-500">${item.source || 'News'} • ${new Date(item.published_at).toLocaleString()}</p>
                            ${item.link ? `<a href="${item.link}" target="_blank" class="text-xs text-cyan-600 hover:underline">Read more</a>` : ''}
                        </div>
                    </li>
                `).join('') : '<li class="text-sm text-slate-500">No recent events captured.</li>';

            // Generate impact analysis for events
            const impactAnalysis = generateEventImpactAnalysis(timeline, company.ticker);

            scoreboard.innerHTML = `
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-semibold text-slate-900">${company.name} (${company.ticker})</h2>
                            <p class="text-sm text-slate-500">${company.sector || ''}${company.industry ? ' • ' + company.industry : ''}</p>
                            ${company.website ? `<a href="${company.website}" target="_blank" class="text-sm text-cyan-600 hover:underline">Company website</a>` : ''}
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-4 py-1.5 rounded-full text-sm font-semibold ${scoreColor(overall.score)}">
                                Overall ${overall.score.toFixed(2)} • ${overall.recommendation}
                            </span>
                            <p class="text-xs text-slate-500 mt-1">Confidence: ${overall.confidence}% • Suggested hold: ${overall.hold_duration}</p>
                        </div>
                    </div>

                    ${company.summary ? `<p class="text-sm leading-relaxed text-slate-600">${company.summary}</p>` : ''}

                    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                        ${componentCards}
                    </div>

                    <div class="rounded-xl border border-slate-200 p-4 bg-slate-50">
                        <h3 class="text-sm font-semibold text-slate-700 uppercase tracking-wide mb-3">Recent Events & Market Impact</h3>
                        ${impactAnalysis}
                    </div>
                </div>
            `;

            insightContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="text-xs uppercase tracking-wide text-slate-500">Key callouts</h4>
                        <p class="mt-1 text-sm text-slate-600">${overall.recommendation} • ${overall.hold_duration}</p>
                        <p class="mt-1 text-xs text-slate-400">Confidence ${overall.confidence}%</p>
                    </div>
                    <div>
                        <h4 class="text-xs uppercase tracking-wide text-slate-500">Leadership</h4>
                        <p class="mt-1 text-sm text-slate-600">${scores.leadership.summary || 'No leadership data.'}</p>
                    </div>
                    <div>
                        <h4 class="text-xs uppercase tracking-wide text-slate-500">Critical path</h4>
                        <p class="mt-1 text-sm text-slate-600">${scores.critical.summary || 'No critical-path explanation.'}</p>
                    </div>
                    <div>
                        <h4 class="text-xs uppercase tracking-wide text-slate-500">Risks & catalysts</h4>
                        <p class="mt-1 text-sm text-slate-600">${scores.sentiment.summary || 'Sentiment signals unavailable.'}</p>
                    </div>
                </div>
            `;
        }

        async function loadScoreboard(ticker) {
            scoreboard.innerHTML = '<p class="text-sm text-slate-500">Loading scorecard...</p>';
            try {
                const response = await fetch(scoreApiUrl(ticker));
                const data = await response.json();
                if (data.status === 'success') {
                    renderScoreboard(data.data);
                } else {
                    scoreboard.innerHTML = `<p class="text-sm text-red-600">Unable to load scores: ${data.message || 'Unknown error'}.</p>`;
                }
            } catch (error) {
                console.error('Error fetching scores:', error);
                scoreboard.innerHTML = '<p class="text-sm text-red-600">Failed to load scorecard. Please try again later.</p>';
            }
        }

        scoreForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const ticker = scoreTickerInput.value.trim().toUpperCase();
            if (!ticker) return;
            loadScoreboard(ticker);
        });

        async function refreshCoverageTable() {
            scoreTable.innerHTML = `
                <div class="mt-4 text-sm text-slate-500">Loading portfolio snapshot...</div>
            `;
            const rows = [];
            for (const ticker of supportedTickers) {
                try {
                    const response = await fetch(scoreApiUrl(ticker));
                    const data = await response.json();
                    if (data.status === 'success') {
                        const overall = data.data.overall;
                        rows.push({ ticker, score: overall.score, recommendation: overall.recommendation, confidence: overall.confidence });
                    } else {
                        rows.push({ ticker, score: null, recommendation: data.message || 'Error', confidence: null });
                    }
                } catch (error) {
                    rows.push({ ticker, score: null, recommendation: 'Fetch error', confidence: null });
                }
            }
            rows.sort((a, b) => (b.score || 0) - (a.score || 0));
            scoreTable.innerHTML = `
                <div class="mt-4 bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-600 uppercase tracking-wide">Ticker</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-600 uppercase tracking-wide">Company</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-600 uppercase tracking-wide">Industry</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-600 uppercase tracking-wide">Score</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-600 uppercase tracking-wide">Recommendation</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-slate-600 uppercase tracking-wide">Confidence</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${rows.map(row => {
                                const metadata = companyMetadata[row.ticker] || { name: row.ticker, industry: 'Unknown' };
                                return `
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-4 py-2 text-sm font-medium text-slate-800">
                                            <a href="https://finance.yahoo.com/quote/${row.ticker}" target="_blank" class="text-cyan-600 hover:text-cyan-800 hover:underline">${row.ticker}</a>
                                        </td>
                                        <td class="px-4 py-2 text-sm text-slate-700">${metadata.name}</td>
                                        <td class="px-4 py-2 text-sm text-slate-600">${metadata.industry}</td>
                                        <td class="px-4 py-2 text-sm ${row.score !== null ? 'text-slate-700' : 'text-slate-400'}">${row.score !== null ? row.score.toFixed(2) : '—'}</td>
                                        <td class="px-4 py-2 text-sm text-slate-700">${row.recommendation}</td>
                                        <td class="px-4 py-2 text-sm text-slate-500">${row.confidence !== null ? row.confidence + '%' : '—'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        loadAllBtn.addEventListener('click', refreshCoverageTable);

        loadScoreboard(scoreTickerInput.value.trim().toUpperCase());
        refreshCoverageTable();

        // Methodology toggle functionality
        document.getElementById('toggleMethodology').addEventListener('click', function() {
            const content = document.getElementById('methodologyContent');
            const chevron = document.getElementById('methodologyChevron');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        });
    </script>
</body>
</html>
